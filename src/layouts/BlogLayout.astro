---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Comments from "@/components/comments/Comments.svelte";
import CommentButton from "@/components/comments/CommentButton.svelte";
import PostReactions from "@/components/reactions/PostReactions.svelte";
import MediaPlayer from "@/components/media/MediaPlayer.svelte";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";
import { formatSimpleDate } from "@/utils/date";
import { supabase } from "@/db/supabase";
import { generateBunnyCDNUrl, generateResponsiveImages, getHeroImageSizes, getAvatarSizes } from "@/utils/image-optimizer";
import { blurhashToDataURL } from "@/utils/blurhash-utils";
 
const { frontmatter } = Astro.props;

// Kullanıcı giriş yapmış mı kontrol et
const isLoggedIn = isAuthenticated(Astro.cookies);
let currentUser = null;

if (isLoggedIn) {
  currentUser = await getUserFromCookies(Astro.cookies, Astro.redirect);
}

// Get post ID from slugs
const postSlug = Astro.params.slug || frontmatter.slug || frontmatter.title.toLowerCase().replace(/\s+/g, '-');
const { data: postData } = await supabase
  .from('posts')
  .select('id, image_blurhash, audio_url, audio_title, audio_artist')
  .eq('slug', postSlug)
  .single();

const postId = postData?.id;
const imageBlurhash = postData?.image_blurhash || null;

// Audio məlumatları Supabase-dən
const dbAudioUrl = postData?.audio_url || null;
const dbAudioTitle = postData?.audio_title || null;
const dbAudioArtist = postData?.audio_artist || null;

// Kateqoriyaları Supabase-dən çək
const { data: categoriesData } = await supabase
  .from('categories')
  .select('slug, name');
const CATEGORIES = categoriesData || [];

// Baxış sayını al
let viewCount = 0;
if (postId) {
  const { count } = await supabase
    .from("post_views")
    .select("*", { count: "exact", head: true })
    .eq("post_id", postId);
  viewCount = count || 0;
}

// Check if comments are enabled
let enableComments = true;
try {
  const { data: commentsSetting } = await supabase
    .from("settings")
    .select("value")
    .eq("key", "enable_comments")
    .single();
  
  if (commentsSetting) {
    enableComments = commentsSetting.value === 'true' || commentsSetting.value === true;
  }
} catch (error) {
  console.error("Comments setting yüklənərkən xəta:", error);
}

// Oxuma vaxtını hesabla
function calculateReadTime(content: string): number {
  const wordCount = content.trim().split(/\s+/).length;
  const wordsPerMinute = 200;
  const readTime = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, readTime);
}

const readTime = calculateReadTime(frontmatter.content || '');

// Audio/Musiqi məlumatları - Supabase-dən və ya frontmatter-dən
const hasAudio = dbAudioUrl || frontmatter.audio?.url;
const audioData = hasAudio ? {
  url: dbAudioUrl || frontmatter.audio?.url,
  title: dbAudioTitle || frontmatter.audio?.title || frontmatter.title,
  artist: dbAudioArtist || frontmatter.audio?.artist || frontmatter.author?.fullname || '',
  cover: frontmatter.image?.url || ''
} : null;

const finalAudioData = audioData;

// Hero şəkil optimizasiyası
const heroImageData = frontmatter.image?.url ? generateResponsiveImages({
  src: frontmatter.image.url,
  width: 1280,
  quality: 85,
  sizes: getHeroImageSizes()
}) : null;

// Avatar optimizasiyası
const avatarUrl = frontmatter.author?.avatar ? generateBunnyCDNUrl(frontmatter.author.avatar, 96, undefined, 80) : null;
const avatarSrcset = frontmatter.author?.avatar ? `${generateBunnyCDNUrl(frontmatter.author.avatar, 48)} 48w, ${generateBunnyCDNUrl(frontmatter.author.avatar, 96)} 96w, ${generateBunnyCDNUrl(frontmatter.author.avatar, 192)} 192w` : '';

// Blurhash-ı instant data URL-ə çevir
const blurhashDataUrl = blurhashToDataURL(imageBlurhash);

---
<BaseLayout 
  title={frontmatter.title} 
  description={frontmatter.description}
  image={frontmatter.image?.url}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": frontmatter.title,
      "description": frontmatter.description,
      "image": [frontmatter.image?.url || "https://the99.az/og-image.jpg"],
      "datePublished": new Date(frontmatter.pubDate).toISOString(),
      "dateModified": frontmatter.modifiedDate 
        ? new Date(frontmatter.modifiedDate).toISOString() 
        : new Date(frontmatter.pubDate).toISOString(),
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": `https://the99.az/notes/${postSlug}`
      },
      "author": {
        "@type": "Person",
        "name": frontmatter.author?.fullname || frontmatter.author?.name || "The99 Redaksiyası",
        "url": "https://the99.az"
      },
      "publisher": {
        "@type": "Organization",
        "name": "The99.az",
        "logo": {
          "@type": "ImageObject",
          "url": "https://the99.b-cdn.net/og-media/1768392610095-3721.jpeg"
        }
      }
    })} />
  </Fragment>
  <div class="fixed top-0 left-0 right-0 h-1 bg-linear-to-r from-rose-500 to-pink-500 origin-left z-50" id="progress-bar" style="transform: scaleX(0); transition: transform 0.1s ease-out;"></div>
  <section>
    <div class="py-24">
      <div class="lg:text-center">
        <div class="max-w-xl mx-auto">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="text-sm font-medium text-zinc-500 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800 px-2.5 py-1 rounded-full">
              {readTime} dəq oxuma vaxtı
            </span>
          </div>
          <h1
            class="text-4xl text-balance font-nouvelr-semibold text-base-900 dark:text-base-50"
          >
            {frontmatter.title}
          </h1>
          
          {/* Gözləmə rejimi göstəricisi */}
          {!frontmatter.approved && frontmatter.isOwner && (
            <div class="mt-3 inline-flex items-center gap-2 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 px-3 py-1.5 rounded-lg text-sm font-semibold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>

              Gözləmədə
            </div>
          )}
          
          <p class="max-w-2xl mx-auto mt-4 text-zinc-500 dark:text-zinc-400 text-sm font-nouvelr">
            {frontmatter.description}
          </p>
        </div>

        <div class="flex justify-center items-center flex-col gap-2 my-10">
         <div class="relative">
          {/* Avatar animasiyası gələcəkdə əlavə olunacaq */}
          {/* <div class="squircle-border -left-[3px] -top-[3.5px]"></div> */}
          {/* <div class="squircle-wrapper"> */}
            <button type="button" class="user-avatar" data-username={frontmatter.author?.username}>
              <img
                width={96}
                height={96}
                src={avatarUrl}
                srcset={avatarSrcset}
                sizes="96px"
                alt={frontmatter.author?.fullname}
                class="squircle size-24 object-cover cursor-pointer"
              />
            </button>
            <div class="absolute -bottom-2 -right-2 bg-white dark:bg-base-950 rounded-full px-2 py-1 flex items-center gap-1 text-xs text-zinc-600 dark:text-zinc-400" data-post-id={postId}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3 animate-pulse">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              </svg>
              <span id="view-count">{viewCount}</span>
            </div>

            <style>
              @keyframes eye-blink {
                0%, 90%, 100% { opacity: 1; }
                95% { opacity: 0.3; }
              }
              .animate-pulse {
                animation: eye-blink 4s infinite;
              }
            </style>
          {/* </div> */}
         </div>
          <div class="mt-3">
            <a href={`/@${frontmatter.author?.username}`} class="hover:text-rose-600 transition-colors">
              <span class="text-md font-medium text-base-700 dark:text-base-300">{frontmatter.author?.fullname}</span>
            </a>
            <p class="text-xs text-zinc-400 dark:text-zinc-500">
              {formatSimpleDate(frontmatter.pubDate)}
            </p>
          </div>
        </div>

        <div class="max-w-6xl mx-auto">
          <div class="flex flex-col justify-between mt-4 md:flex-row">
            <div class="flex gap-3">
              {
                (frontmatter.categories || []).map((categorySlug: string) => {
                  const categoryObj = CATEGORIES.find((cat: { slug: string; name: string }) => cat.slug === categorySlug);
                  return (
                    <span class="hover:text-blue-500 text-sm font-medium text-base-600 dark:text-base-400">
                      <a href={`/category/${categorySlug}`}>{categoryObj ? categoryObj.name : categorySlug}</a>
                    </span>
                  );
                })
              }
            </div>
            {currentUser && (
              <div class="mt-2 md:mt-0">
                <a
                  href={`/edit-post/${Astro.params.slug || frontmatter.slug}`}
                  class="inline-flex items-center px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Redaktə et
                </a>
              </div>
            )}
          </div>

          {frontmatter.image && frontmatter.image.url && heroImageData && (
            <div class="relative blurhash-container mt-4 overflow-hidden rounded-xl" data-blurhash={imageBlurhash}
                 style={blurhashDataUrl ? `background-image:url(${blurhashDataUrl});background-size:cover;` : ''}>
              {imageBlurhash && (
                <canvas 
                  class="blurhash-canvas absolute inset-0 w-full h-full object-cover rounded-xl z-10" 
                  aria-hidden="true"
                />
              )}
              <img
                width={1280}
                height={720}
                src={heroImageData.src}
                srcset={heroImageData.srcset}
                sizes={heroImageData.sizes}
                alt={frontmatter.image.alt || frontmatter.title}
                loading="eager"
                fetchpriority="high"
                decoding="async"
                class="blurhash-img object-cover object-center aspect-12/7 rounded-xl w-full"
              />
            </div>
          )}

        </div>
      </div>

      <div class="prose prose-sm dark:prose-invert max-w-md mt-12 mx-auto" id="post-content">
        <slot />
      </div>

      {postId && (
        <PostReactions
          client:only="svelte"
          postId={postId}
          userEmail={currentUser?.email}
        />
      )}

      {enableComments && (
        <>
          <Comments client:only="svelte" postSlug={postSlug} />
          <CommentButton client:only="svelte" hasMediaPlayer={!!finalAudioData} />
        </>
      )}

      {/* Media Player - yalnız audio varsa göstər */}
      {finalAudioData && (
        <MediaPlayer
          client:visible
          audioUrl={finalAudioData.url}
          title={finalAudioData.title}
          artist={finalAudioData.artist}
          coverImage={finalAudioData.cover ? generateBunnyCDNUrl(finalAudioData.cover, 300) : ''}
        />
      )}

      <script is:inline>
        function loadYoutubeVideos() {
          const youtubeContainers = document.querySelectorAll('div[data-youtube-video]');

          youtubeContainers.forEach(container => {
            if (container.querySelector('iframe')) return;

            const videoId = container.getAttribute('data-youtube-video');

            if (videoId) {
              const iframe = document.createElement('iframe');
              iframe.src = `https://www.youtube.com/embed/${videoId}`;
              iframe.width = '100%';
              iframe.height = '100%';
              iframe.frameBorder = '0';
              iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
              iframe.allowFullscreen = true;
              iframe.classList.add('aspect-video');
              iframe.style.maxWidth = '100%';

              container.innerHTML = '';
              container.appendChild(iframe);
            }
          });
        }

        let progressBarTicking = false;

        function updateProgressBar() {
          const progressBar = document.getElementById('progress-bar');
          if (!progressBar) return;

          const postContent = document.getElementById('post-content');
          if (!postContent) {
            progressBar.style.transform = 'scaleX(0)';
            return;
          }

          const windowHeight = window.innerHeight;
          const contentRect = postContent.getBoundingClientRect();
          const contentTop = contentRect.top;
          const contentHeight = contentRect.height;

          if (contentTop > windowHeight) {
            progressBar.style.transform = 'scaleX(0)';
            return;
          }

          if (contentTop + contentHeight < 0) {
            progressBar.style.transform = 'scaleX(1)';
            return;
          }

          const scrollProgress = Math.max(0, Math.min(1, (windowHeight - contentTop) / (windowHeight + contentHeight)));
          progressBar.style.transform = `scaleX(${scrollProgress})`;

          progressBarTicking = false;
        }

        function requestProgressBarUpdate() {
          if (!progressBarTicking) {
            window.requestAnimationFrame(updateProgressBar);
            progressBarTicking = true;
          }
        }

        window.addEventListener('scroll', requestProgressBarUpdate, { passive: true });
        window.addEventListener('resize', requestProgressBarUpdate, { passive: true });
        document.addEventListener('astro:after-swap', () => {
          updateProgressBar();
          window.addEventListener('scroll', requestProgressBarUpdate, { passive: true });
          window.addEventListener('resize', requestProgressBarUpdate, { passive: true });
        });

        // Sayfa ilk yüklenirken
        document.addEventListener('DOMContentLoaded', loadYoutubeVideos);

        // Astro sayfa geçişlerinde
        document.addEventListener('astro:page-load', loadYoutubeVideos);

        // Astro içerik güncellendiğinde
        document.addEventListener('astro:after-swap', loadYoutubeVideos);
      </script>

      <script> 
        import { navigate } from 'astro:transitions/client';
        import { decode } from 'blurhash';

        function setupUserAvatarClick() {
          const userAvatar = document.querySelector('.user-avatar');
          if (userAvatar) {
            userAvatar.addEventListener('click', () => {
              const username = userAvatar.getAttribute('data-username');
              if (username) {
                navigate(`/@${username}`);
              }
            });
          }
        }
        
        function initBlurhash() {
          const containers = document.querySelectorAll('.blurhash-container[data-blurhash]');
          
          containers.forEach((container) => {
            const blurhash = container.getAttribute('data-blurhash');
            const canvas = container.querySelector('.blurhash-canvas') as HTMLCanvasElement;
            const img = container.querySelector('.blurhash-img') as HTMLImageElement;
            
            if (!blurhash || !canvas) return;
            
            try {
              const width = 32;
              const height = 32;
              const pixels = decode(blurhash, width, height);
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              
              if (ctx) {
                const imageData = ctx.createImageData(width, height);
                imageData.data.set(pixels);
                ctx.putImageData(imageData, 0, 0);
              }
              
              if (img) {
                if (img.complete && img.naturalWidth > 0) {
                  setTimeout(() => {
                    canvas.style.opacity = '0';
                  }, 500);
                } else {
                  img.addEventListener('load', () => {
                    setTimeout(() => {
                      canvas.style.opacity = '0';
                    }, 300);
                  });
                }
              }
            } catch (error) {
              console.error('Blurhash decode xətası:', error);
            }
          });
        }
        
        function initImageZoom() {
          const postContent = document.getElementById('post-content');
          if (!postContent) return;

          const images = postContent.querySelectorAll('img');
          
          images.forEach(img => {
            if ((img as HTMLImageElement).style.cursor === 'zoom-in') return;
            
            (img as HTMLImageElement).style.cursor = 'zoom-in';
            (img as HTMLImageElement).style.transition = 'transform 0.3s ease';
            
            img.addEventListener('click', function(e) {
              e.stopPropagation();
              
              const imgEl = this as HTMLImageElement;
              if (imgEl.dataset.zoomed === 'true') {
                imgEl.style.transform = 'scale(1)';
                imgEl.style.position = 'relative';
                imgEl.style.zIndex = 'auto';
                imgEl.dataset.zoomed = 'false';
                imgEl.style.cursor = 'zoom-in';
                return;
              }
              
              imgEl.style.transform = 'scale(1.5)';
              imgEl.style.position = 'relative';
              imgEl.style.zIndex = '50';
              imgEl.dataset.zoomed = 'true';
              imgEl.style.cursor = 'zoom-out';
            });
          });
          
          document.addEventListener('click', function(e) {
            const zoomedImg = postContent.querySelector('img[data-zoomed="true"]') as HTMLImageElement;
            if (zoomedImg && !zoomedImg.contains(e.target as Node)) {
              zoomedImg.style.transform = 'scale(1)';
              zoomedImg.style.position = 'relative';
              zoomedImg.style.zIndex = 'auto';
              zoomedImg.dataset.zoomed = 'false';
              zoomedImg.style.cursor = 'zoom-in';
            }
          });
        }
        
        // İlk yükləmə üçün
        setupUserAvatarClick();
        initBlurhash();
        initImageZoom();
        
        // Transitions sonrası yenidən quraşdır
        document.addEventListener('astro:after-swap', () => {
          setupUserAvatarClick();
          initBlurhash();
          initImageZoom();
        });
      </script>
      
      <style>
        .blurhash-canvas {
          transition: opacity 0.3s ease-out;
        }
        
        /* Blockquote styling overrides */
        .prose :global(blockquote) {
          font-style: normal !important;
        }
        .prose :global(blockquote p::before),
        .prose :global(blockquote p::after) {
          content: none !important;
        }
      </style>

      <script is:inline>
        // Baxış sayını qeyd et
        async function recordView() {
          const viewCountEl = document.getElementById('view-count');
          const container = viewCountEl?.parentElement;
          const postId = container?.getAttribute('data-post-id');
          
          if (!postId) return;
          
          try {
            const response = await fetch('/api/posts/views', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ postId: parseInt(postId) })
            });
            
            if (response.ok) {
              const data = await response.json();
              if (viewCountEl && data.viewCount !== undefined) {
                viewCountEl.textContent = data.viewCount;
              }
            }
          } catch (error) {
            console.error('Baxış qeyd edilərkən xəta:', error);
          }
        }
        
        // Səhifə yükləndikdə baxışı qeyd et
        recordView();
      </script>
    </div>
  </section>
</BaseLayout>
