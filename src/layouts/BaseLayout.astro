---
import BaseHead from "@/components/BaseHead.astro";
import Navigation from "@/components/global/Navigation.astro";
import Footer from "@/components/global/Footer.astro";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";
import { supabase } from "@/db/supabase";

interface Props {
  title?: string;
  description?: string;
  hideFooter?: boolean;
}

const { title: pageTitle, description: pageDescription, hideFooter = false } = Astro.props;
const isLoggedIn = isAuthenticated(Astro.cookies);
let user = null;

if (isLoggedIn) {
  user = await getUserFromCookies(Astro.cookies, Astro.redirect);
  
  // Əgər cookie var amma user null-dursa (token vaxtı bitib), cookie-ləri sil
  if (!user) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
  }
}

// Settings-dən sayt başlığı və təsvirini al
let siteTitle = "The 99";
let siteDescription = "Azərbaycan texnoloji bloqu";

try {
  const { data: settings } = await supabase
    .from("settings")
    .select("key, value")
    .in("key", ["site_title", "site_description"]);

  if (settings) {
    for (const setting of settings) {
      if (setting.key === "site_title" && setting.value) {
        siteTitle = setting.value;
      }
      if (setting.key === "site_description" && setting.value) {
        siteDescription = setting.value;
      }
    }
  }
} catch (error) {
  console.error("Settings yüklənərkən xəta:", error);
}

// Səhifə başlığı: əgər verilmişsə, sayt başlığı ilə birləşdir
const finalTitle = pageTitle ? `${pageTitle} | ${siteTitle}` : siteTitle;
const finalDescription = pageDescription || siteDescription;
---

<html lang="en">  
  <head>   
    <BaseHead title={finalTitle} description={finalDescription} />
  </head>
  <body class=`flex flex-col min-h-screen px-4 sm:px-6 md:px-8 mx-auto bg-white`>
    <Navigation isLoggedIn={isLoggedIn} user={user} /> 
    <main class="grow">
      <slot />
    </main>
    {!hideFooter && <Footer />}
  </body>

  <script is:inline>
    if ("paintWorklet" in CSS) {
      CSS.paintWorklet.addModule(
        "https://www.unpkg.com/css-houdini-squircle/squircle.min.js"
      );
    }
  </script>
  
  {isLoggedIn && (
    <script>
      import '@/scripts/auth-check';
    </script>
  )}
</html>
  