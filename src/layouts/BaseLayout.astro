---
import BaseHead from "@/components/BaseHead.astro";
import Navigation from "@/components/global/Navigation.astro";
import Footer from "@/components/global/Footer.astro";
import ChangelogModal from "@/components/changelog/ChangelogModal.svelte";
import LanguageSwitcher from "@/components/global/LanguageSwitcher.astro";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";
import { supabase } from "@/db/supabase";
import { getLocaleFromCookie, defaultLocale, type Locale } from "@/utils/i18n";

interface Props {
  title?: string;
  description?: string;
  hideFooter?: boolean;
  hideHeader?: boolean;
  image?: string;
  locale?: Locale;
}

const { title: pageTitle, description: pageDescription, hideFooter = false, hideHeader = false, image, locale: propLocale } = Astro.props;

// Dil ayarını cookie-dən və ya props-dan al
const locale = propLocale || getLocaleFromCookie(Astro.cookies);
const isLoggedIn = isAuthenticated(Astro.cookies);
let user = null;

if (isLoggedIn) {
  user = await getUserFromCookies(Astro.cookies, Astro.redirect);

  console.log('User ::::::::>', user)
  
  // Əgər cookie var amma user null-dursa (token vaxtı bitib), cookie-ləri sil
  if (!user) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
  }
}

// Settings-dən sayt başlığı və təsvirini al
let siteTitle = "";
let siteDescription = "";

try {
  const { data: settings } = await supabase
    .from("settings")
    .select("key, value")
    .in("key", ["site_title", "site_description"]);

  if (settings) {
    for (const setting of settings) {
      if (setting.key === "site_title" && setting.value) {
        siteTitle = setting.value;
      }
      if (setting.key === "site_description" && setting.value) {
        siteDescription = setting.value;
      }
    }
  }
} catch (error) {
  console.error("Settings yüklənərkən xəta:", error);
}

// Səhifə başlığı: əgər verilmişsə, sayt başlığı ilə birləşdir
const finalTitle = pageTitle ? `${pageTitle} | ${siteTitle}` : siteTitle;
const finalDescription = pageDescription || siteDescription;
---

<html lang={locale}>  
  <head>   
    <BaseHead title={finalTitle} description={finalDescription} image={image} />
    <slot name="head" />
  </head>
  <body class=`flex flex-col min-h-screen px-4 sm:px-6 md:px-8 mx-auto bg-white`>
    {!hideHeader && <Navigation isLoggedIn={isLoggedIn} user={user} locale={locale} />}
    <LanguageSwitcher locale={locale} /> 
    <main class="grow">
      <slot />
    </main>
    {!hideFooter && <Footer locale={locale} />}
    
    <!-- Changelog Modal -->
    <ChangelogModal client:load />
  </body>

  <script is:inline>
    if ("paintWorklet" in CSS) {
      CSS.paintWorklet.addModule(
        "https://www.unpkg.com/css-houdini-squircle/squircle.min.js"
      );
    }

    // Google OAuth hash fragment callback handler
    (async function() {
      if (window.location.hash && window.location.hash.includes('access_token')) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');

        if (accessToken && refreshToken) {
          try {
            const response = await fetch('/api/auth/set-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                access_token: accessToken,
                refresh_token: refreshToken,
              }),
            });

            if (response.ok) {
              // Hash-i təmizlə və səhifəni yenilə
              window.history.replaceState(null, '', window.location.pathname);
              window.location.reload();
            }
          } catch (error) {
            console.error('OAuth callback error:', error);
          }
        }
      }
    })();
  </script>
  
  {isLoggedIn && (
    <script>
      import '@/scripts/auth-check';
    </script>
  )}
</html>
  