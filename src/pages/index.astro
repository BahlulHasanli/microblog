---
import BaseLayout from "@/layouts/BaseLayout.astro";
import InfinitePostList from "@/components/entries/InfinitePostList.svelte";
import Slider from "@/components/entries/HomeSlider.astro";
import FixedTabBar from "@/components/tabs/FixedTabBar.astro";
import MainTabs from "@/components/tabs/MainTabs.astro";
import { supabase } from "@/db/supabase";
import { isAuthenticated } from "@/utils/auth";
import { buildCategoryTree, type Category } from "@/utils/category-helpers";

const currentPath = Astro.url.pathname;

// Get site settings for structured data
let siteTitle = "THE DOXSANDOQQUZ";
let siteDescription = "Azərbaycan dilində pop-kultura, əyləncə və müasir mədəniyyət haqqında etibarlı məlumat mənbəyi.";

let postsPerPage = 10;

try {
  const { data: settings } = await supabase
    .from("settings")
    .select("key, value")
    .in("key", ["site_title", "site_description", "posts_per_page"]);

  if (settings) {
    for (const setting of settings) {
      if (setting.key === "site_title" && setting.value) {
        siteTitle = setting.value;
      }
      if (setting.key === "site_description" && setting.value) {
        siteDescription = setting.value;
      }
      if (setting.key === "posts_per_page" && setting.value) {
        postsPerPage = parseInt(setting.value) || 10;
      }
    }
  }
} catch (error) {
  console.error("Settings yüklənərkən xəta:", error);
}

// Supabase-dən kategoriyaları al
const { data: categoriesData, error: categoriesError } = await supabase
  .from("categories")
  .select("*")
  .order("sort_order", { ascending: true })
  .order("id", { ascending: true });

const categories = (categoriesData || []) as Category[];
const categoryTree = buildCategoryTree(categories);

if (categoriesError) {
  console.warn('Kategoriyalar yüklənərkən xəta:', categoriesError);
}

// Supabase-dən sponsor bannerləri al
let sponsorBanners: any[] = [];
const { data: bannersData, error: bannersError } = await supabase
  .from("sponsor_banners")
  .select("*")
  .eq("is_active", true)
  .order("click_count", { ascending: false });

console.log('=== SPONSOR BANNERS INDEX DEBUG ===');
console.log('Error:', bannersError);
console.log('Data:', bannersData);
console.log('Data count:', bannersData?.length);

if (bannersData && Array.isArray(bannersData)) {
  sponsorBanners = bannersData;
  console.log('✓ Sponsor banners loaded:', sponsorBanners.length);
} else {
  console.log('✗ No sponsor banners found');
}


// Supabase-dən ilk səhifə postlarını al
const { data: postsData, error: postsError } = await supabase
  .from("posts")
  .select(`
    *,
    users:author_id (avatar, fullname, username)
  `)
  .eq("approved", true)
  .order("pub_date", { ascending: false })
  .range(0, postsPerPage - 1);

if (postsError) {
  console.error('Postlar yüklənərkən xəta:', postsError);
}

// Postları formatla
const posts = (postsData || []).map(post => {
  return {
    slug: post.slug,
    id: post.id,
    data: {
      title: post.title,
      description: post.description,
      pubDate: post.pub_date,
      image: {
        url: post.image_url || '',
        alt: post.image_alt || post.title
      },
      blurhash: post.image_blurhash || null,
      categories: post.categories,
      approved: post.approved,
      featured: post.featured,
      author: post.users,
      hasAudio: post.content ? post.content.includes('<audio') : false
    }
  };
});
---

<BaseLayout>
  <section> 
    <Slider />
    <FixedTabBar activeTab="weekly" />
    
    <div class="py-6 sm:py-8 md:py-12 max-w-3xl mx-auto px-4 sm:px-0">
      <div class="mb-8 sm:mb-12"> 
        <MainTabs activeTab="weekly" />

      <div class="mt-3 sm:mt-4">
        {/* Kateqoriyalar — horizontal scroll */}
        <div class="cat-bar">
          <div class="cat-track">
            {
              categoryTree.map((parentCat) => {
                const hasChildren = parentCat.children && parentCat.children.length > 0;
                
                if (hasChildren) {
                  return (
                    <div 
                      class="cat-link group"
                      data-has-children="true"
                      data-slug={parentCat.slug}
                    >
                      <span>{parentCat.name}</span>
                      <a 
                        href={`/category/${parentCat.slug}`}
                        class="cat-link-icon"
                        title="Bölməyə keç"
                        aria-label={`${parentCat.name} səhifəsinə keç`}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5">
                          <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 0 0-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75v-4a.75.75 0 0 1 1.5 0v4A2.25 2.25 0 0 1 12.75 17h-8.5A2.25 2.25 0 0 1 2 14.75v-8.5A2.25 2.25 0 0 1 4.25 4h5a.75.75 0 0 1 0 1.5h-5Z" clip-rule="evenodd" />
                          <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 0 0 1.06.053L16.5 4.44v2.81a.75.75 0 0 0 1.5 0v-4.5a.75.75 0 0 0-.75-.75h-4.5a.75.75 0 0 0 0 1.5h2.553l-9.056 8.194a.75.75 0 0 0-.053 1.06Z" clip-rule="evenodd" />
                        </svg>
                      </a>
                    </div>
                  );
                }

                return (
                  <a 
                    href={`/category/${parentCat.slug}`}
                    class="cat-link"
                    data-has-children="false"
                    data-slug={parentCat.slug}
                  >
                    {parentCat.name}
                  </a>
                );
              })
            }
          </div>
        </div>

        {/* Alt kateqoriya satırı */}
        <div class="cat-sub" id="cat-sub-row">
          {
            categoryTree.map((parentCat) => (
              parentCat.children && parentCat.children.length > 0 && (
                <div class="cat-sub-group" data-parent-slug={parentCat.slug}>
                  {parentCat.children.map((childCat) => (
                    <a 
                      href={`/category/${childCat.slug}`}
                      class="cat-sub-link"
                    >
                      {childCat.name}
                    </a>
                  ))}
                </div>
              )
            ))
          }
        </div>
        <div class="mt-10">
          {
            posts.length > 0 ? (
              <InfinitePostList 
                client:load
                initialPosts={posts}
                categories={categories}
                sponsorBanners={sponsorBanners}
                initialPage={1}
                postsPerPage={postsPerPage}
              />
            ) : (
              <div class="grid grid-cols-1 sm:grid-cols-2">
                <div class="col-span-1 sm:col-span-2 py-16 sm:py-24">
                  <div class="flex flex-col items-center justify-center text-center">
                    <div class="mb-6 p-4 rounded-2xl bg-slate-50 dark:bg-base-800">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-slate-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243-1.59-1.59" />
                      </svg>
                    </div>
                    <h3 class="text-lg sm:text-lg font-nouvelr-semibold text-slate-900 dark:text-base-50 mb-2">Hələ ki, post yoxdur</h3>
                    <p class="text-sm sm:text-sm text-slate-500 dark:text-base-400 max-w-sm">Yeni məzmun tezliklə əlavə olunacaq. Bizi izləyin!</p>
                  </div>
                </div>
              </div>
            )
          }
        </div>
      </div>
     </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* ──── Kateqoriya barı ──── */
  .cat-bar {
    position: relative;
    margin-top: 1.5rem;
    margin-bottom: 0.125rem;
  }

  .cat-track {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .cat-link {
    flex-shrink: 0;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: oklch(56.83% 0.015 281.34);
    text-decoration: none;
    transition: all 0.15s ease;
    white-space: nowrap;
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    cursor: pointer;
  }

  .cat-link-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
    opacity: 0.4;
    transition: all 0.2s ease;
    padding: 2px;
    border-radius: 4px;
  }

  .cat-link-icon:hover {
    opacity: 1;
    background-color: rgba(0,0,0,0.05);
    color: #f43f5e;
  }

  .cat-link:hover {
    color: oklch(23.48% 0.004 264.49);
    background-color: oklch(96.74% 0.001 286.38);
  }

  .cat-link.active {
    color: oklch(23.48% 0.004 264.49);
    font-weight: 600;
    background-color: oklch(93.73% 0.001 286.37);
  }

  /* Aktiv parent varsa, qalanları solğunlaşdır */
  .cat-bar.has-active .cat-link:not(.active) {
    opacity: 0.35;
    filter: blur(0.5px);
  }

  .cat-bar.has-active .cat-link:not(.active):hover {
    opacity: 0.7;
    filter: none;
  }

  /* ──── Alt kateqoriya satırı ──── */
  .cat-sub {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.2s ease;
  }

  .cat-sub.open {
    max-height: 120px;
    opacity: 1;
  }

  .cat-sub-group {
    display: none;
    gap: 0.3rem;
    flex-wrap: wrap;
    padding: 0.5rem 0 0.25rem;
  }

  .cat-sub-group.visible {
    display: flex;
    align-items: center;
  }

  .cat-sub-link {
    padding: 0.3rem 0.625rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: oklch(56.83% 0.015 281.34);
    text-decoration: none;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .cat-sub-link:hover {
    color: oklch(23.48% 0.004 264.49);
    background-color: oklch(96.74% 0.001 286.38);
  }

  /* Dark mode variants */
  :global(.dark) .cat-link {
    color: #a1a1aa;
  }
  
  :global(.dark) .cat-link:hover {
    color: #f8fafc;
    background-color: #27272a;
  }
  
  :global(.dark) .cat-link.active {
    color: #f8fafc;
    background-color: #3f3f46;
  }

  :global(.dark) .cat-link-icon:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  :global(.dark) .cat-sub-link {
    color: #a1a1aa;
  }

  :global(.dark) .cat-sub-link:hover {
    color: #f8fafc;
    background-color: #27272a;
  }

  /* ──── Responsive ──── */
  @media (max-width: 640px) {
    .cat-link {
      font-size: 0.75rem;
      padding: 0.3125rem 0.625rem;
    }
    .cat-sub-link {
      font-size: 0.6875rem;
      padding: 0.1875rem 0.5625rem;
    }
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const links = document.querySelectorAll('.cat-link');
    const subRow = document.getElementById('cat-sub-row');
    const subGroups = document.querySelectorAll('.cat-sub-group');
    const catBar = document.querySelector('.cat-bar');

    // Link icon kliklərini tutubstopPropagation (JS) edək
    const linkIcons = document.querySelectorAll('.cat-link-icon');
    linkIcons.forEach(icon => {
      icon.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    let activeSlug: string | null = null;
    
    // Səhifə yeniləndikdə və ya geri qayıtdıqda state sıfırlanır, ona görə null start ok.

    links.forEach(link => {
      // HTMLElement kimi cast edirik ki, dataset-ə çata bilək
      const el = link as HTMLElement;
      const hasChildren = el.dataset.hasChildren === 'true';
      const slug = el.dataset.slug!;

      el.addEventListener('click', (e) => {
        if (!hasChildren) return; 
        
        // Əgər birbaşa linkdirsə (hasChildren=false), bu handler onsuz da href-ə mane olmur, 
        // amma div olduğu üçün (hasChildren=true) default yoxdur.
        
        // Ctrl/Cmd dəstəyi
        const ev = e as MouseEvent;
        if (ev.ctrlKey || ev.metaKey) return; 

        e.preventDefault();

        if (activeSlug === slug) {
          activeSlug = null;
          links.forEach(l => l.classList.remove('active'));
          subGroups.forEach(g => g.classList.remove('visible'));
          subRow?.classList.remove('open');
          catBar?.classList.remove('has-active');
        } else {
          activeSlug = slug;
          links.forEach(l => l.classList.remove('active'));
          el.classList.add('active');

          subGroups.forEach(g => {
            const groupEl = g as HTMLElement;
            if (groupEl.dataset.parentSlug === slug) {
              groupEl.classList.add('visible');
            } else {
              groupEl.classList.remove('visible');
            }
          });
          subRow?.classList.add('open');
          catBar?.classList.add('has-active');
        }
      });
    });
  });
</script>
