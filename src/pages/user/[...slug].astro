---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";
import ProfileHeader from "@/components/profile/ProfileHeader";
import ProfileTabs from "@/components/profile/ProfileTabs";
import { supabase } from "@/db/supabase";
import { formatISO } from "@/utils/date";

export const prerender = false;

const { slug } = Astro.params;

// Extract username from slug (remove @ prefix if present)
let username = slug;
if (username?.startsWith("@")) {
  username = username.slice(1);
}

// İstifadəçi məlumatlarını username ilə al
const { data: userData, error: userError } = await supabase
  .from("users") 
  .select("id, fullname, username, avatar, email")
  .eq("username", username)
  .single();

if (userError || !userData) {
  console.error("İstifadəçi tapılmadı:", userError);
  return Astro.redirect("/404");
}

const user = userData;

// Cari istifadəçini yoxla (giriş etmişsə)
const isLoggedIn = isAuthenticated(Astro.cookies);
let currentUser = null;
let isOwner = false;

if (isLoggedIn) {
  currentUser = await getUserFromCookies(Astro.cookies, Astro.redirect);
  // Profil sahibi ilə cari istifadəçini müqayisə et
  isOwner = currentUser?.id === user.id;
}

// İstifadəçinin postlarını al
const { data: postsData, error: postsError } = await supabase
  .from("posts")
  .select("*")
  .eq("author_email", user.email)
  .order("pub_date", { ascending: false });

if (postsError) {
  console.error('Postlar yüklənərkən xəta:', postsError);
}

const posts = (postsData || []).map(post => ({
  id: post.id,
  title: post.title,
  description: post.description,
  slug: post.slug,
  image: post.image_url || '',
  created_at: formatISO(post.pub_date),
  categories: post.categories || []
}));
---

<BaseLayout>
  <div class="max-w-3xl mx-auto pt-4 sm:pt-6 md:pt-8 pb-8 sm:pb-12 md:pb-16 px-4 sm:px-0">
    <ProfileHeader 
      client:load 
      user={user}
      isOwner={isOwner}
    />
    
    <ProfileTabs 
      client:load 
      posts={posts || []} 
      userId={user.id}
      isOwner={isOwner}
    />
  </div>
</BaseLayout>
