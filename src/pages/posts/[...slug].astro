---
import { supabase } from "@/db/supabase";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";
import MarkdownPostLayout from "../../layouts/BlogLayout.astro";
import { marked } from "marked";

export const prerender = false;

const { slug } = Astro.params;

// Supabase-dən postu və müəllif məlumatlarını al
const { data: post, error } = await supabase
  .from("posts")
  .select(`
    *,
    users:author_id (avatar, fullname, username)
  `)
  .eq("slug", slug)
  .single();

if (error || !post) {
  console.error('Post tapılmadı:', error);
  return new Response(null, { status: 404 });
}

// Cari istifadəçini yoxla
const isLoggedIn = isAuthenticated(Astro.cookies);
let currentUser = null;
let isOwner = false;

if (isLoggedIn) {
  currentUser = await getUserFromCookies(Astro.cookies, Astro.redirect);
  isOwner = currentUser?.id === post.author_id;
}

// Əgər post təsdiqlənməmişsə və cari istifadəçi sahibi deyilsə, 404 qaytarın
if (!post.approved && !isOwner) {
  console.error('Post təsdiqlənməmişdir və cari istifadəçi sahibi deyildir');
  return new Response(null, { status: 404 });
}

// Markdown-ı HTML-ə çevir
// Əvvəlcə escape edilmiş \n simvollarını real yeni sətir simvolları ilə əvəz et
const cleanContent = post.content.replace(/\\n/g, '\n');

// Custom renderer for Rating component
let htmlContent = await marked(cleanContent);

// Replace <Rating score="X" /> tags with rendered component (GameInformer style)
const ratingRegex = /<Rating\s+score=["']([^"']+)["']\s*\/>/gi;
htmlContent = htmlContent.replace(ratingRegex, (match, score) => {
  const numericScore = parseFloat(score);

  const ratingHtml = `
    <div class="rounded-2xl mx-auto text-center flex flex-col items-center bg-white w-full">
      <div class="text-7xl font-black leading-none text-black mt-5">${numericScore.toFixed(1)}</div>
      <p class="text-sm text-blue-600 mb-5">Müəllifin balı</p>
    </div>
  `;
  return ratingHtml;
});

// Frontmatter formatında məlumat hazırla
const frontmatter = {
  title: post.title,
  description: post.description,
  pubDate: post.pub_date ? new Date(post.pub_date) : new Date(),
  image: {
    url: post.image_url || '',
    alt: post.image_alt || post.title
  },
  categories: post.categories || [],
  author: post.users,
  approved: post.approved || false,
  isOwner: isOwner,
  content: cleanContent,
};
---

<MarkdownPostLayout frontmatter={frontmatter}>
  <article set:html={htmlContent} />
</MarkdownPostLayout>
