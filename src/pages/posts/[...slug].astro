---
import { supabase } from "@/db/supabase";
import MarkdownPostLayout from "../../layouts/BlogLayout.astro";
import { marked } from "marked";

export const prerender = false;

const { slug } = Astro.params;

// Supabase-dən postu al
const { data: post, error } = await supabase
  .from("posts")
  .select("*")
  .eq("slug", slug)
  .single();

if (error || !post) {
  console.error('Post tapılmadı:', error);
  return new Response(null, { status: 404 });
}

// Müəllifin güncel avatar məlumatlarını al
const { data: authorData } = await supabase
  .from("users")
  .select("avatar")
  .eq("fullname", post.author_name)
  .single();

// Markdown-ı HTML-ə çevir
// Əvvəlcə escape edilmiş \n simvollarını real yeni sətir simvolları ilə əvəz et
const cleanContent = post.content.replace(/\\n/g, '\n');
const htmlContent = marked(cleanContent);

// Frontmatter formatında məlumat hazırla
const frontmatter = {
  title: post.title,
  description: post.description,
  pubDate: new Date(post.pub_date),
  image: {
    url: post.image_url || '',
    alt: post.image_alt || post.title
  },
  author: {
    name: post.author_name,
    avatar: authorData?.avatar || post.author_avatar || ''
  },
  categories: post.categories || [],
  tags: post.tags || []
};
---

<MarkdownPostLayout frontmatter={frontmatter}>
  <article set:html={htmlContent} />
</MarkdownPostLayout>
