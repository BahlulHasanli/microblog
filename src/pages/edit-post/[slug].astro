---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostEditor from '../../components/PostEditor';
import { supabase } from "@/db/supabase";
import { isAuthenticated, getUserFromCookies } from "@/utils/auth";

export const prerender = false;

const { slug } = Astro.params;

// İstifadəçi giriş edibmi yoxla
const isLoggedIn = isAuthenticated(Astro.cookies);

if (!isLoggedIn) {
  return Astro.redirect("/signin");
}

const user = await getUserFromCookies(Astro.cookies, Astro.redirect);

if (!user) {
  return Astro.redirect("/signin");
}

// Supabase-dən postu al
const { data: post, error } = await supabase
  .from("posts")
  .select("*")
  .eq("slug", slug)
  .single();

if (error || !post) {
  console.error('Post tapılmadı:', error);
  return new Response(null, { status: 404 });
}

// Post məlumatlarını formatla
const postData = {
  title: post.title,
  description: post.description,
  pubDate: new Date(post.pub_date),
  image: {
    url: post.image_url || '',
    alt: post.image_alt || post.title
  },
  categories: post.categories || [],
  approved: post.approved,
  featured: post.featured
};
---

<BaseLayout title={`${post.title} Düzenle`}>
  <PostEditor 
    post={postData} 
    content={post.content} 
    slug={slug} 
    author={user} 
    client:visible 
  />
</BaseLayout>

<style>
  @import "../../styles/_variables.scss";
  @import "../../styles/_keyframe-animations.scss";
</style>
