---
export const prerender = false;
import BaseLayout from "@/layouts/BaseLayout.astro";
import { isAuthenticated } from "@/utils/auth";

if (isAuthenticated(Astro.cookies)) {
  return Astro.redirect("/");
}
---

<BaseLayout title="Giriş edilir...">
  <div class="min-h-[60vh] flex items-center justify-center">
    <div class="text-center px-4">
      <div class="mb-6">
        <div class="w-16 h-16 mx-auto mb-4 relative">
          <div class="absolute inset-0 rounded-full border-4 border-base-200"></div>
          <div class="absolute inset-0 rounded-full border-4 border-rose-500 border-t-transparent animate-spin"></div>
        </div>
        <h1 class="text-lg font-semibold text-base-900 mb-1">Giriş edilir</h1>
        <p class="text-sm text-base-500">Zəhmət olmasa gözləyin...</p>
      </div>
      <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-600 text-sm px-4 py-3 rounded-lg">
        Xəta baş verdi. Yenidən cəhd edin.
      </div>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>

  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_KEY
    );

    async function handleCallback() {
      const errorMessageDiv = document.getElementById('error-message');
      
      function showError(message: string) {
        if (errorMessageDiv) {
          errorMessageDiv.textContent = message;
          errorMessageDiv.classList.remove('hidden');
        }
        setTimeout(() => {
          window.location.href = '/signin?error=callback_failed';
        }, 3000);
      }

      try {
        const isOAuthFlow = sessionStorage.getItem('oauthFlow') === 'true';
        
        // Disable repeated use of same flow
        sessionStorage.removeItem('oauthFlow');

        if (!isOAuthFlow) {
          console.log('No active OAuth flow detected, redirecting to sign in');
          
          // Clear any ghost session from local storage autocomplete
          await supabase.auth.signOut();
          
          // Strip any hash or parameters before redirecting
          if (window.location.hash || window.location.search) {
             window.history.replaceState(null, '', window.location.pathname);
          }
          
          window.location.href = '/signin';
          return;
        }

        // Debug: URL-i konsola yaz
        console.log('Callback URL:', window.location.href);
        console.log('Hash:', window.location.hash);
        console.log('Search:', window.location.search);

        // URL-dən error yoxla
        const urlParams = new URLSearchParams(window.location.search);
        const errorParam = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        if (errorParam) {
          console.error('OAuth error:', errorParam, errorDescription);
          showError(errorDescription || 'Giriş xətası baş verdi');
          return;
        }

        // Code parametri varsa, əvvəlcə onu yoxla (PKCE flow - Apple və Google)
        const code = urlParams.get('code');
        if (code) {
          console.log('Code found, exchanging for session...');
          const { data: exchangeData, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
          
          if (exchangeError) {
            console.error('Exchange error:', exchangeError);
            showError(exchangeError.message || 'Session yaradıla bilmədi');
            return;
          }

          if (exchangeData.session) {
            console.log('Session created, setting cookies...');
            const response = await fetch('/api/auth/set-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                access_token: exchangeData.session.access_token,
                refresh_token: exchangeData.session.refresh_token,
              }),
            });

            if (response.ok) {
              console.log('Cookies set, redirecting to home...');
              window.location.href = '/';
            } else {
              const errorData = await response.json().catch(() => ({}));
              console.error('Set session API error:', errorData);
              showError('Cookie qurulması xətası');
            }
            return;
          }
        }

        // Hash fragment-dən session almağa çalış (implicit flow - older mechanism)
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');

        if (accessToken && refreshToken) {
          console.log('Tokens found in hash, setting session...');
          const { data: sessionData, error: setError } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken,
          });

          if (setError) {
            console.error('Set session error:', setError);
            showError(setError.message || 'Session qurulması xətası');
            return;
          }

          const response = await fetch('/api/auth/set-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              access_token: accessToken,
              refresh_token: refreshToken,
            }),
          });

          if (response.ok) {
            window.location.href = '/';
          } else {
            showError('Cookie qurulması xətası');
          }
          return;
        }

        // Mövcud session yoxla (Supabase-js already parsed hash automatically)
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Session error:', error);
          showError(error.message || 'Session xətası');
          return;
        }

        if (data.session) {
          console.log('Existing session found, setting cookies...');
          const response = await fetch('/api/auth/set-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              access_token: data.session.access_token,
              refresh_token: data.session.refresh_token,
            }),
          });

          if (response.ok) {
            window.location.href = '/';
          } else {
            showError('Cookie qurulması xətası');
          }
          return;
        }

        // Heç bir session tapılmadı
        console.error('No session found');
        showError('Session tapılmadı. Yenidən cəhd edin.');
      } catch (err) {
        console.error('Callback error:', err);
        showError('Gözlənilməz xəta baş verdi');
      }
    }

    handleCallback();
  </script>
</BaseLayout>
