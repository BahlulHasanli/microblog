---
import { supabase } from "@/db/supabase";
import SliderReadMoreBtn from "@/components/ui/SliderReadMoreBtn.svelte";
import { formatShortDate, formatSimpleDate } from "@/utils/date";

// Supabase-dən featured postları al
const { data: featuredPostsData, error } = await supabase
  .from("posts")
  .select("*")
  .eq("featured", true)
  .eq("approved", true)
  .order("pub_date", { ascending: false })
  .limit(1);

if (error) {
  console.error('Featured postlar yüklənərkən xəta:', error);
}

// İlk featured postu formatla
const featuredPostData = featuredPostsData && featuredPostsData.length > 0 ? featuredPostsData[0] : null;

const featuredPost = featuredPostData ? {
  slug: featuredPostData.slug,
  data: {
    title: featuredPostData.title,
    description: featuredPostData.description,
    pubDate: new Date(featuredPostData.pub_date),
    image: {
      url: featuredPostData.image_url,
      alt: featuredPostData.image_alt || featuredPostData.title
    },
    featured: featuredPostData.featured
  }
} : null;

const backgroundImage = featuredPost?.data.image.url;


const { data } = await supabase.from('posts') 
  .select(`
    *,
    users:author_email (avatar, fullname)
  `).single()

---

{featuredPost && (
  <>
    <div class="absolute inset-0 h-[700px] overflow-hidden -z-10">
      <img src={backgroundImage}
      alt={featuredPost.data.title} 
      class="w-full h-full object-cover opacity-40" 
      />
      <div class="absolute inset-0 bg-gradient-to-t from-white to-transparent backdrop-blur-xs"></div>
    </div>

    <div class="max-w-6xl mx-auto w-full overflow-hidden relative h-[500px] bg-zinc-600 mt-8 rounded-xl">
    <!-- Right Side -->
    <div class="absolute right-0 top-0 w-1/2 h-full">
        <img src={backgroundImage}
        alt={featuredPost.data.title}
        class="w-full h-full object-cover object-center" 
        />
    </div> 
  
      <!-- Left Side -->
    <div class="absolute left-0 top-0 w-[855px] h-full z-10">
        <img src={backgroundImage}  
        alt={featuredPost.data.title}
        class="size-[750px] object-cover blur-3xl -mt-28 object-center" 
        />
        <div class="absolute inset-0 ml-15 flex flex-col justify-between pt-24 mb-10">
            <div class="text-white flex flex-col gap-1 w-[470px]">
                <h2 class="text-4xl font-semibold font-display m-0 break-words tracking-wide">
                  {featuredPost && featuredPost.data.title}
                </h2>
                <p class="text-md font-light opacity-70 mt-5 break-words font-display tracking-wide">
                  {featuredPost && featuredPost.data.description}
                </p>
            </div>
  
            <div class="flex w-[420px] flex-row gap-6 items-center justify-between mt-10">
               <div class="flex flex-row gap-2 items-center">
                    <img src={data?.users.avatar} 
                    alt={data?.users.fullname} 
                    class="squircle !w-[80px] !h-[78px]" />
                   <div class="flex flex-col ml-2">
                    <span class="text-white/80 font-medium text-[15px]">
                      {data?.users.fullname}
                    </span>
                    <p class="text-white/50 font-light text-[11px]">
                      {featuredPost && formatSimpleDate(featuredPost.data.pubDate)}
                    </p>
                   </div> 
               </div>

               <SliderReadMoreBtn client:idle slug={featuredPost.slug} />
            </div>
        </div>
    </div>
    </div>
  </>
)} 
