---
import { supabase } from "@/db/supabase";
import { formatShortDate, formatSimpleDate } from "@/utils/date";
import { generateResponsiveImages, generateBunnyCDNUrl, getAvatarSizes, getHeroImageSizes } from "@/utils/image-optimizer";
import { blurhashToDataURL } from "@/utils/blurhash-utils";

// Supabase-dən featured postları al
const { data: featuredPostsData, error } = await supabase
  .from("posts")
  .select(`
    *,
    users:author_id (avatar, fullname, username)
  `)
  .eq("featured", true)
  .eq("approved", true)
  .order("pub_date", { ascending: false })
  .limit(1);

if (error) {
  console.error('Featured postlar yüklənərkən xəta:', error);
}

// İlk featured postu formatla
const featuredPostData = featuredPostsData && featuredPostsData.length > 0 ? featuredPostsData[0] : null;

const featuredPost = featuredPostData ? {
  slug: featuredPostData.slug,
  data: {
    title: featuredPostData.title,
    description: featuredPostData.description,
    pubDate: new Date(featuredPostData.pub_date),
    image: {
      url: featuredPostData.image_url,
      alt: featuredPostData.image_alt || featuredPostData.title
    },
    featured: featuredPostData.featured,
    author: featuredPostData.users,
    hasAudio: featuredPostData.content ? featuredPostData.content.includes('<audio') : false
  }
} : null;

const backgroundImage = featuredPost?.data.image.url;

// Responsive images
const heroImageData = backgroundImage ? generateResponsiveImages({
  src: backgroundImage,
  width: 800,
  quality: 80,
  sizes: getHeroImageSizes()
}) : null;

// Arxa plan blur üçün kiçik ölçülü şəkil (ayrı URL - dublikat sorğu olmasın)
const bgBlurUrl = backgroundImage ? generateBunnyCDNUrl(backgroundImage, 320, undefined, 50, 'webp') : null;

// Blurhash-dan daha böyük data URL (sol tərəf blur üçün - ayrı network sorğusu lazım deyil)
const blurhashBlurUrl = blurhashToDataURL(featuredPostData?.image_blurhash, 8, 6);

const avatarImageData = featuredPost?.data.author?.avatar ? generateResponsiveImages({
  src: featuredPost.data.author.avatar,
  width: 80,
  quality: 80,
  sizes: getAvatarSizes()
}) : null;

// Blurhash instant placeholder
const imageBlurhash = featuredPostData?.image_blurhash || null;
const blurhashDataUrl = blurhashToDataURL(imageBlurhash);

---

{featuredPost && (
  <>
    {!featuredPost.data.hasAudio && (
      <div class="absolute inset-0 h-[300px] sm:h-[500px] md:h-[700px] overflow-hidden -z-10">
        <img
          src={bgBlurUrl || backgroundImage}
          alt=""
          loading="eager"
          decoding="async"
          class="w-full h-full object-cover opacity-40"
        />
        <div class="absolute inset-0 bg-linear-to-t from-white to-transparent backdrop-blur-xs"></div>
      </div>
    )}

    {featuredPost.data.hasAudio ? (
      <!-- Audio Post Design (The New Yorker Style) -->
      <div class="max-w-6xl mx-auto w-full relative sm:h-[400px] md:h-[500px] mt-4 sm:mt-6 md:mt-8 flex flex-col sm:flex-row bg-white rounded-lg sm:rounded-xl overflow-hidden">
        <!-- Left Side: Blurred background with white overlay, centered content -->
        <div class="relative w-full sm:w-1/2 p-6 sm:p-12 flex flex-col justify-center items-center text-center overflow-hidden">
            <!-- Background Image with Blur -->
            <img
                src={bgBlurUrl || backgroundImage}
                alt=""
                class="absolute inset-0 w-full h-full object-cover blur-2xl opacity-60 scale-110"
                loading="eager"
            />
            <!-- White Transparent Overlay -->
            <div class="absolute inset-0 bg-white/80"></div>

            <!-- Content -->
            <div class="relative z-10 w-full flex flex-col items-center">
              {featuredPost.data.author && (
                <div class="text-[10px] sm:text-[11px] font-bold text-red-600 tracking-widest uppercase mb-4 font-sans">
                  {featuredPost.data.author.fullname}
                </div>
              )}

              <h2 class="text-3xl sm:text-4xl md:text-5xl font-normal leading-tight mx-auto font-nouvelr-semibold  text-slate-900 line-clamp-3 mb-4 max-w-sm">
                  <a href={`/posts/${featuredPost.slug}`} class="hover:underline decoration-3 underline-offset-4">
                    {featuredPost.data.title}
                  </a>
              </h2>

              <!-- Excerpt -->
              <p class="text-[15px] sm:text-[17px] font-display text-slate-500 leading-relaxed max-w-md mx-auto line-clamp-3 mb-8">
                  {featuredPost.data.description}
              </p>

              <!-- Listen Button -->
              <a href={`/posts/${featuredPost.slug}`} class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-slate-900 text-white font-sans font-semibold text-[13px] hover:bg-slate-800 transition-colors shadow-sm">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="size-4">
                      <path d="M12 1.5C6.2 1.5 1.5 6.2 1.5 12V17C1.5 20 4 22.5 7 22.5H7.5V20.9C8.4 20.7 9 19.9 9 19V15C9 14.1 8.4 13.3 7.5 13.1V11.5H7C5.1 11.5 3.5 12.4 2.5 13.8V12C2.5 6.8 6.8 2.5 12 2.5C17.2 2.5 21.5 6.8 21.5 12V13.8C20.5 12.4 18.9 11.5 17 11.5H16.5V13.1C15.6 13.3 15 14.1 15 15V19C15 19.9 15.6 20.7 16.5 20.9V22.5H17C20 22.5 22.5 20 22.5 17V12C22.5 6.2 17.8 1.5 12 1.5ZM6.5 12.5V21.5C4.3 21.3 2.5 19.3 2.5 17C2.5 14.7 4.3 12.8 6.5 12.5ZM17.5 21.5V12.5C19.7 12.7 21.5 14.7 21.5 17C21.5 19.3 19.7 21.2 17.5 21.5Z" fill="currentColor"></path>
                  </svg>
                  Dinlə
              </a>
            </div>
        </div>

        <!-- Right Side: Cover Image -->
        <div class="w-full sm:w-1/2 h-[300px] sm:h-auto shrink-0 relative">
            <a href={`/posts/${featuredPost.slug}`} class="block w-full h-full relative" aria-label={featuredPost.data.title}>
              <div class="absolute inset-0" style={blurhashDataUrl ? `background-image:url(${blurhashDataUrl});background-size:cover;` : ''}></div>
              <img
                  src={heroImageData?.src || backgroundImage}
                  srcset={heroImageData?.srcset}
                  sizes={heroImageData?.sizes}
                  alt={featuredPost.data.title}
                  loading="eager"
                  fetchpriority="high"
                  decoding="async"
                  class="w-full h-full object-cover object-center relative z-10"
              />
            </a>
        </div>
      </div>
    ) : (
      <!-- Standard Overlay Post Design -->
      <div class="max-w-6xl mx-auto w-full overflow-hidden relative h-[250px] sm:h-[350px] md:h-[500px] bg-zinc-600 mt-4 sm:mt-6 md:mt-8 rounded-lg sm:rounded-xl"
           style={blurhashDataUrl ? `background-image:url(${blurhashDataUrl});background-size:cover;` : ''}>
      <!-- Right Side - Hidden on mobile -->
      <div class="hidden sm:block absolute right-0 top-0 w-1/2 h-full">
          <img
            src={heroImageData?.src || backgroundImage}
            srcset={heroImageData?.srcset}
            sizes={heroImageData?.sizes}
            alt={featuredPost.data.title}
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-cover object-center"
          />
      </div> 
    
        <!-- Left Side -->
      <div class="absolute left-0 top-0 w-full sm:w-[855px] h-full z-10">
          <!-- Blur arxa plan - blurhash data URL istifadə edir (network sorğusu yoxdur) -->
          <img
            src={blurhashBlurUrl || bgBlurUrl || backgroundImage}
            alt=""
            loading="eager"
            decoding="async"
            class="sm:hidden absolute inset-0 w-full h-full object-cover blur-2xl opacity-80"
          />
          <img
            src={blurhashBlurUrl || bgBlurUrl || backgroundImage}
            alt=""
            loading="eager"
            decoding="async"
            class="hidden sm:block size-[750px] object-cover blur-3xl -mt-28 object-center"
          />
          <div class="absolute inset-0 px-4 sm:ml-15 flex flex-col justify-between pt-4 sm:pt-24 pb-4 sm:mb-10">
              <div class="text-white flex flex-col gap-1 w-full sm:w-[470px]">
                  <h2 class="text-lg sm:text-2xl md:text-3xl font-semibold  m-0 wrap-break-word tracking-wide line-clamp-3">
                    {featuredPost && featuredPost.data.title}
                  </h2>
                  <p class="text-xs sm:text-sm md:text-md font-light opacity-70 mt-2 sm:mt-5 wrap-break-word line-clamp-2 sm:line-clamp-none">
                    {featuredPost && featuredPost.data.description}
                  </p>
              </div>
    
              <div class="flex w-full sm:w-[320px] flex-row items-center justify-between mt-3 sm:mt-10 gap-2">
                 <button type="button" id="user-profile" class="cursor-pointer flex flex-row gap-1 sm:gap-2 items-center hover:opacity-90 transition-opacity min-w-0">
                      <div class="w-10! sm:w-[80px]! h-10! sm:h-[78px]!">
                        <img
                          src={avatarImageData?.src || featuredPost.data.author?.avatar}
                          srcset={avatarImageData?.srcset}
                          sizes={avatarImageData?.sizes}
                          alt={featuredPost.data.author?.fullname}
                          loading="lazy"
                          decoding="async"
                          class="squircle w-full h-full object-cover"
                        />
                      </div>
                     <div class="flex flex-col ml-1 sm:ml-4 min-w-0">
                      <span data-username={featuredPost.data.author?.username} class="text-white/80 font-medium text-[11px] sm:text-[15px] truncate">
                        {featuredPost.data.author?.fullname}
                      </span>
                      <p class="text-white/50 font-light text-left text-[9px] sm:text-[11px]">
                        {featuredPost && formatSimpleDate(featuredPost.data.pubDate)}
                      </p>
                     </div> 
                 </button>
  
                 <a 
                    href={`/posts/${featuredPost.slug}`}
                    aria-label="Məqaləni oxu"
                    class="bg-white/70 backdrop-blur-xl hover:bg-white/50 transition-all cursor-pointer flex items-center gap-2 px-5 py-2 rounded-full"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-5">
                      <circle cx="6" cy="15" r="4"/><circle cx="18" cy="15" r="4"/>
                      <path d="M14 15a2 2 0 0 0-2-2 2 2 0 0 0-2 2"/>
                      <path d="M2.5 13 5 7c.7-1.3 1.4-2 3-2"/>
                      <path d="M21.5 13 19 7c-.7-1.3-1.5-2-3-2"/>
                    </svg>
                  </a>
              </div>
          </div>
      </div>
      </div>
    )}
  </>
)}  
 
<script>
  import { navigate } from "astro:transitions/client";

  function attachUserProfileListener() {
    const userProfile = document.querySelector("#user-profile");
    const userName = document.querySelector("[data-username]");
    
    if (userProfile && userName) {
      userProfile.addEventListener("click", () => {
        navigate(`/@${userName.getAttribute("data-username")}`);
      });
    }
  }

  // İlk yükləmə zamanı
  attachUserProfileListener();

  // Page transition-dan sonra yenidən attach et
  document.addEventListener("astro:after-swap", attachUserProfileListener);
</script>