---
import { supabase } from "@/db/supabase";
import SliderReadMoreBtn from "@/components/ui/SliderReadMoreBtn.svelte";
import { formatShortDate, formatSimpleDate } from "@/utils/date";
import { generateResponsiveImages, generateBunnyCDNUrl, getAvatarSizes, getHeroImageSizes } from "@/utils/image-optimizer";

// Supabase-dən featured postları al
const { data: featuredPostsData, error } = await supabase
  .from("posts")
  .select(`
    *,
    users:author_id (avatar, fullname, username)
  `)
  .eq("featured", true)
  .eq("approved", true)
  .order("pub_date", { ascending: false })
  .limit(1);

if (error) {
  console.error('Featured postlar yüklənərkən xəta:', error);
}

// İlk featured postu formatla
const featuredPostData = featuredPostsData && featuredPostsData.length > 0 ? featuredPostsData[0] : null;

const featuredPost = featuredPostData ? {
  slug: featuredPostData.slug,
  data: {
    title: featuredPostData.title,
    description: featuredPostData.description,
    pubDate: new Date(featuredPostData.pub_date),
    image: {
      url: featuredPostData.image_url,
      alt: featuredPostData.image_alt || featuredPostData.title
    },
    featured: featuredPostData.featured,
    author: featuredPostData.users
  }
} : null;

const backgroundImage = featuredPost?.data.image.url;

// Responsive images
const heroImageData = backgroundImage ? generateResponsiveImages({
  src: backgroundImage,
  width: 800,
  quality: 80,
  sizes: getHeroImageSizes()
}) : null;

// Blur background üçün kiçik ölçülü şəkil (200px, 60% quality)
const blurBackgroundUrl = backgroundImage ? generateBunnyCDNUrl(backgroundImage, 200, undefined, 60, 'webp') : null;

const avatarImageData = featuredPost?.data.author?.avatar ? generateResponsiveImages({
  src: featuredPost.data.author.avatar,
  width: 80,
  quality: 80,
  sizes: getAvatarSizes()
}) : null;

---

{featuredPost && (
  <>
    <div class="absolute inset-0 h-[300px] sm:h-[500px] md:h-[700px] overflow-hidden -z-10">
      <img
        src={heroImageData?.src || backgroundImage}
        srcset={heroImageData?.srcset}
        sizes={heroImageData?.sizes}
        alt={featuredPost.data.title}
        loading="eager"
        fetchpriority="high"
        decoding="async"
        class="w-full h-full object-cover opacity-40"
      />
      <div class="absolute inset-0 bg-linear-to-t from-white to-transparent backdrop-blur-xs"></div>
    </div>

    <div class="max-w-6xl mx-auto w-full overflow-hidden relative h-[250px] sm:h-[350px] md:h-[500px] bg-zinc-600 mt-4 sm:mt-6 md:mt-8 rounded-lg sm:rounded-xl">
    <!-- Right Side - Hidden on mobile -->
    <div class="hidden sm:block absolute right-0 top-0 w-1/2 h-full">
        <img
          src={heroImageData?.src || backgroundImage}
          srcset={heroImageData?.srcset}
          sizes={heroImageData?.sizes}
          alt={featuredPost.data.title}
          loading="eager"
          fetchpriority="high"
          decoding="async"
          class="w-full h-full object-cover object-center"
        />
    </div> 
  
      <!-- Left Side -->
    <div class="absolute left-0 top-0 w-full sm:w-[855px] h-full z-10">
        <!-- Mobil üçün blur arxa plan -->
        <img
          src={blurBackgroundUrl || backgroundImage}
          alt=""
          loading="eager"
          decoding="async"
          class="sm:hidden absolute inset-0 w-full h-full object-cover blur-2xl opacity-80"
        />
        <!-- Desktop üçün blur arxa plan -->
        <img
          src={blurBackgroundUrl || backgroundImage}
          alt=""
          loading="eager"
          decoding="async"
          class="hidden sm:block size-[750px] object-cover blur-3xl -mt-28 object-center"
        />
        <div class="absolute inset-0 px-4 sm:ml-15 flex flex-col justify-between pt-4 sm:pt-24 pb-4 sm:mb-10">
            <div class="text-white flex flex-col gap-1 w-full sm:w-[470px]">
                <h2 class="text-lg sm:text-2xl md:text-3xl font-semibold  m-0 wrap-break-word tracking-wide line-clamp-3">
                  {featuredPost && featuredPost.data.title}
                </h2>
                <p class="text-xs sm:text-sm md:text-md font-light opacity-70 mt-2 sm:mt-5 wrap-break-word line-clamp-2 sm:line-clamp-none">
                  {featuredPost && featuredPost.data.description}
                </p>
            </div>
  
            <div class="flex w-full sm:w-[320px] flex-row items-center justify-between mt-3 sm:mt-10 gap-2">
               <button type="button" id="user-profile" class="cursor-pointer flex flex-row gap-1 sm:gap-2 items-center hover:opacity-90 transition-opacity min-w-0">
                    <div class="w-10! sm:w-[80px]! h-10! sm:h-[78px]!">
                      <img
                        src={avatarImageData?.src || featuredPost.data.author?.avatar}
                        srcset={avatarImageData?.srcset}
                        sizes={avatarImageData?.sizes}
                        alt={featuredPost.data.author?.fullname}
                        loading="lazy"
                        decoding="async"
                        class="squircle w-full h-full object-cover"
                      />
                    </div>
                   <div class="flex flex-col ml-1 sm:ml-4 min-w-0">
                    <span data-username={featuredPost.data.author?.username} class="text-white/80 font-medium text-[11px] sm:text-[15px] truncate">
                      {featuredPost.data.author?.fullname}
                    </span>
                    <p class="text-white/50 font-light text-left text-[9px] sm:text-[11px]">
                      {featuredPost && formatSimpleDate(featuredPost.data.pubDate)}
                    </p>
                   </div> 
               </button>

               <SliderReadMoreBtn client:idle slug={featuredPost.slug} />
            </div>
        </div>
    </div>
    </div>
  </>
)}  
 
<script>
  import { navigate } from "astro:transitions/client";

  function attachUserProfileListener() {
    const userProfile = document.querySelector("#user-profile");
    const userName = document.querySelector("[data-username]");
    
    if (userProfile && userName) {
      userProfile.addEventListener("click", () => {
        navigate(`/user/@${userName.getAttribute("data-username")}`);
      });
    }
  }

  // İlk yükləmə zamanı
  attachUserProfileListener();

  // Page transition-dan sonra yenidən attach et
  document.addEventListener("astro:after-swap", attachUserProfileListener);
</script>