---
import { Image } from "astro:assets";
import { formatSimpleDate } from "@/utils/date";
import { generateResponsiveImages, generateBunnyCDNUrl, getBlogEntrySizes, getHeroImageSizes } from "@/utils/image-optimizer";
import { blurhashToDataURL } from "@/utils/blurhash-utils";

interface Props {
  title: string;
  url: string;
  description: string;
  image: string;
  categories?: string[];
  author?: { avatar?: string; fullname?: string; username?: string };
  pubDate?: Date;
  blurhash?: string;
  allCategories?: { slug: string; name: string; parent_id?: number | null }[];
  postId?: string;
  page?: 'home' | 'category';
  hasAudio?: boolean;
}

const { title, url, description, image, categories, author, pubDate, blurhash, allCategories = [], postId, page, hasAudio } = Astro.props;
const CATEGORIES = allCategories;

const isIcmal = categories?.includes('icmal') || false;

// Responsive images üçün
const responsiveImageData = generateResponsiveImages({
  src: image,
  width: 800,
  quality: 80,
  sizes: isIcmal ? getHeroImageSizes() : getBlogEntrySizes()
});

// Background blur üçün kiçik şəkil
const blurBackgroundUrl = generateBunnyCDNUrl(image, 200, undefined, 60, 'webp');

// Blurhash-ı instant data URL-ə çevir (ağ boşluq əvəzinə anında göstərilir)
const blurhashDataUrl = blurhashToDataURL(blurhash);
 
---
 
{isIcmal && page === 'home' ? (
  <article class="relative w-full rounded-xl overflow-hidden group">
    <div class="absolute inset-0">
      <img src={blurBackgroundUrl} alt="" class="w-full h-full object-cover scale-110" />
    </div>
    <div class="absolute inset-0 backdrop-blur-3xl"></div>
    <div class="absolute inset-0 bg-black/10"></div>
    
    <div class="relative z-10 p-6 sm:p-8 flex flex-col sm:flex-row gap-6 items-center">
      <a href={url} title={title} class="block w-full sm:w-1/2 shrink-0 relative group-hover:opacity-90 transition-opacity">
        {hasAudio && (
          <div class="absolute top-3 right-3 sm:top-4 sm:right-4 z-20 bg-black/60 backdrop-blur-md text-white border border-white/10 px-3 py-1.5 rounded-full pointer-events-none flex items-center gap-1.5">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4">
              <path d="M12 1.5C6.2 1.5 1.5 6.2 1.5 12V17C1.5 20 4 22.5 7 22.5H7.5V20.9C8.4 20.7 9 19.9 9 19V15C9 14.1 8.4 13.3 7.5 13.1V11.5H7C5.1 11.5 3.5 12.4 2.5 13.8V12C2.5 6.8 6.8 2.5 12 2.5C17.2 2.5 21.5 6.8 21.5 12V13.8C20.5 12.4 18.9 11.5 17 11.5H16.5V13.1C15.6 13.3 15 14.1 15 15V19C15 19.9 15.6 20.7 16.5 20.9V22.5H17C20 22.5 22.5 20 22.5 17V12C22.5 6.2 17.8 1.5 12 1.5ZM6.5 12.5V21.5C4.3 21.3 2.5 19.3 2.5 17C2.5 14.7 4.3 12.8 6.5 12.5ZM17.5 21.5V12.5C19.7 12.7 21.5 14.7 21.5 17C21.5 19.3 19.7 21.2 17.5 21.5Z" fill="currentColor"></path>
            </svg>
            <span class="text-[11px] font-bold tracking-wider uppercase pt-[1px]">Dinlə</span>
          </div>
        )}
        <div class="relative blurhash-container overflow-hidden rounded-2xl" data-blurhash={blurhash}
             style={blurhashDataUrl ? `background-image:url(${blurhashDataUrl});background-size:cover;` : ''}>
          {blurhash && (
            <canvas
              class="blurhash-canvas absolute inset-0 w-full h-full object-cover rounded-2xl"
              aria-hidden="true"
            />
          )}
          <img
            width={800}
            height={450}
            src={responsiveImageData.src}
            srcset={responsiveImageData.srcset}
            sizes={responsiveImageData.sizes}
            alt={title}
            loading="lazy"
            decoding="async"
            class="blurhash-img object-cover w-full aspect-video rounded-2xl"
          />
        </div>
      </a>
      
      <div class="flex-1 text-white flex flex-col justify-center">
        <div class="flex items-center gap-2 text-sm text-white/80 mb-4">
          <button type="button" class="user-avatar overflow-hidden size-8 squircle cursor-pointer shrink-0" data-username={author?.username}>
            <img src={author?.avatar}
                alt={author?.fullname}
                class="w-full h-full object-cover"
            />
          </button>
          <a href={`/@${author?.username}`} class="font-medium hover:text-white transition-colors truncate">
            {author?.fullname}
          </a>
          {pubDate && (
            <div class="flex items-center ml-auto gap-2">
              <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-3.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
              />
            </svg>
            <span class="text-xs text-white/60">{formatSimpleDate(pubDate)}</span>
            {postId && (
              <>
                <span aria-hidden="true" class="text-white/40">&middot;</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-3.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178Z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                  />
                </svg>
                <span class="view-count text-xs text-white/60" data-post-id={postId}>0</span>
              </>
            )}
            </div>
          )}
        </div>
        
        <h3 class="text-2xl sm:text-2xl font-bold mb-2 leading-tight text-pretty">
          <a href={url} class="group-hover:underline decoration-wavy line-clamp-2">{title}</a>
        </h3>
        
        <p class="text-white/80 line-clamp-3 text-base sm:text-md my-5">{description}</p>
        
        {categories && categories.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-5">
            {categories.map((categorySlug) => {
              const categoryObj = CATEGORIES.find((cat: { slug: string; name: string }) => cat.slug === categorySlug);
              return (
                <a 
                  href={`/category/${categorySlug}`}
                  class="bg-white/20 hover:bg-white/30 text-white text-xs font-medium px-3 py-1 rounded-full transition-colors"
                >
                  {categoryObj ? categoryObj.name : categorySlug}
                </a>
              );
            })}
          </div>
        )} 
        
      </div>
    </div>
  </article>
) : (
  <article class="flex flex-col flex-1 h-full group">
    <a href={url} title={title} class="block relative group-hover:opacity-90 transition-opacity">
      {hasAudio && (
        <div class="absolute top-3 right-3 sm:top-4 sm:right-4 z-20 bg-black/60 backdrop-blur-md text-white border border-white/10 px-3 py-1.5 rounded-full pointer-events-none flex items-center gap-1.5">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4">
            <path d="M12 1.5C6.2 1.5 1.5 6.2 1.5 12V17C1.5 20 4 22.5 7 22.5H7.5V20.9C8.4 20.7 9 19.9 9 19V15C9 14.1 8.4 13.3 7.5 13.1V11.5H7C5.1 11.5 3.5 12.4 2.5 13.8V12C2.5 6.8 6.8 2.5 12 2.5C17.2 2.5 21.5 6.8 21.5 12V13.8C20.5 12.4 18.9 11.5 17 11.5H16.5V13.1C15.6 13.3 15 14.1 15 15V19C15 19.9 15.6 20.7 16.5 20.9V22.5H17C20 22.5 22.5 20 22.5 17V12C22.5 6.2 17.8 1.5 12 1.5ZM6.5 12.5V21.5C4.3 21.3 2.5 19.3 2.5 17C2.5 14.7 4.3 12.8 6.5 12.5ZM17.5 21.5V12.5C19.7 12.7 21.5 14.7 21.5 17C21.5 19.3 19.7 21.2 17.5 21.5Z" fill="currentColor"></path>
          </svg>
          <span class="text-[11px] font-bold tracking-wider uppercase pt-[1px]">Dinlə</span>
        </div>
      )}
      <div class="block w-full lg:col-span-2 blurhash-container relative overflow-hidden rounded-xl" data-blurhash={blurhash}
           style={blurhashDataUrl ? `background-image:url(${blurhashDataUrl});background-size:cover;` : ''}>
        {blurhash && (
          <canvas
            class="blurhash-canvas absolute inset-0 w-full h-full object-cover rounded-xl"
            aria-hidden="true"
          />
        )}
        <img
          width={800}
          height={450}
          src={responsiveImageData.src}
          srcset={responsiveImageData.srcset}
          sizes={responsiveImageData.sizes}
          alt={title}
          loading="lazy"
          decoding="async"
          class="blurhash-img object-cover w-full h-full bg-center aspect-12/8 rounded-xl"
        />
      </div>
    </a>

  <div class="mt-3 sm:mt-5">
    <div class="flex items-center gap-1 sm:gap-2 text-xs text-base-500 dark:text-base-400 flex-wrap">
      <button type="button" class="user-avatar overflow-hidden size-10! sm:size-14! squircle cursor-pointer shrink-0" data-username={author?.username}>
        <img src={author?.avatar}
            alt={author?.fullname}
            class="w-full h-full object-cover"
        />
      </button>
      <a href={`/@${author?.username}`} class="font-medium hover:text-rose-600 dark:text-base-300 dark:hover:text-rose-400 transition-colors truncate">
        {author?.fullname}
      </a>
      {categories && categories.length > 0 && (
        <>
          <span aria-hidden="true">&middot;</span>
          <span>
            {categories.map((categorySlug, index) => {
              const categoryObj = CATEGORIES.find((cat: { slug: string; name: string }) => cat.slug === categorySlug);
              return (
                <a 
                  href={`/category/${categorySlug}`}
                  class="text-yellow-700 dark:text-yellow-500"
                >
                  {categoryObj ? categoryObj.name : categorySlug}{index < categories.length - 1 && ','}
                </a>
              );
            }).reduce((acc, el, i, arr) => {
              acc.push(el);
              if (i < arr.length - 1) acc.push(' ');
              return acc;
            }, [])}
          </span>
        </>
      )}
    </div>

    <h3 class="mt-4 text-base text-base-900 dark:text-base-50 text-balance">
      <a href={url} class="group-hover:underline group-hover:decoration-1 group-hover:decoration-wavy">
        {title}
      </a>
    </h3>

    <p class="mt-1 text-sm text-base-500 dark:text-base-400 line-clamp-2">{description}</p>

    {pubDate && (
      <div class="flex items-center gap-2 mt-3 text-xs text-base-500 dark:text-base-400">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-3.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
          />
        </svg>
        <span>
          {formatSimpleDate(pubDate)}
        </span>
        {postId && (
          <>
            <span aria-hidden="true">&middot;</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="size-3.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178Z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
              />
            </svg>
            <span class="view-count" data-post-id={postId}>0</span>
          </>
        )}
      </div>
    )}
  </div>
  </article>
)}
 
<script>
   import { navigate } from "astro:transitions/client";
   import { decode } from "blurhash";
   
    function setupUserAvatarClick() {
        const userAvatar = document.querySelector('.user-avatar');
        if (userAvatar) {
            userAvatar.addEventListener('click', () => {
                const username = userAvatar.getAttribute('data-username');
                if (username) {
                    navigate(`/@${username}`);
                }
            });
        }
    }

    async function loadViewCounts() {
        const viewCountElements = document.querySelectorAll('.view-count[data-post-id]');
        if (viewCountElements.length === 0) return;
        
        // Bütün post ID-lərini topla
        const postIds: string[] = [];
        viewCountElements.forEach(element => {
            const postId = element.getAttribute('data-post-id');
            if (postId) postIds.push(postId);
        });
        
        if (postIds.length === 0) return;
        
        try {
            // Batch sorğu - birdəfəyə bütün view count-ları al
            const response = await fetch(`/api/posts/views?postIds=${postIds.join(',')}`);
            if (response.ok) {
                const data = await response.json();
                if (data.viewCounts) {
                    viewCountElements.forEach(element => {
                        const postId = element.getAttribute('data-post-id');
                        if (postId && data.viewCounts[postId] !== undefined) {
                            element.textContent = data.viewCounts[postId];
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Oxunma sayları yüklənərkən xəta:', error);
        }
    }
    
    function initBlurhash() {
      const containers = document.querySelectorAll('.blurhash-container[data-blurhash]');
      
      containers.forEach((container) => {
        const blurhash = container.getAttribute('data-blurhash');
        const canvas = container.querySelector('.blurhash-canvas') as HTMLCanvasElement;
        const img = container.querySelector('.blurhash-img') as HTMLImageElement;
        
        if (!blurhash || !canvas) return;
        
        try {
          const width = 32;
          const height = 32;
          const pixels = decode(blurhash, width, height);
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          if (ctx) {
            const imageData = ctx.createImageData(width, height);
            imageData.data.set(pixels);
            ctx.putImageData(imageData, 0, 0);
          }
          
          if (img) {
            // Şəkil artıq yüklənibsə, bir az gözlə sonra gizlət (effekti görmək üçün)
            if (img.complete && img.naturalWidth > 0) {
              setTimeout(() => {
                canvas.style.opacity = '0';
              }, 500);
            } else {
              img.addEventListener('load', () => {
                setTimeout(() => {
                  canvas.style.opacity = '0';
                }, 300);
              });
            }
          }
        } catch (error) {
          console.error('Blurhash decode xətası:', error);
        }
      });
    }
    
    // İlk yükləmə üçün
    setupUserAvatarClick();
    loadViewCounts();
    initBlurhash();
    
    // Transitions sonrası yenidən quraşdır
    document.addEventListener('astro:after-swap', () => {
      setupUserAvatarClick();
      loadViewCounts();
      initBlurhash();
    });
</script>

<style>
  .blurhash-canvas {
    transition: opacity 0.3s ease-out;
  }
</style>
