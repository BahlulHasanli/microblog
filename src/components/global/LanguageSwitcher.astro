---
import { locales, useTranslations, type Locale } from "@/utils/i18n";

const { locale = 'az' as Locale } = Astro.props;
const t = useTranslations(locale);

const languageNames: Record<Locale, string> = {
  az: 'AZ',
  en: 'EN',
  ru: 'RU'
};
---

<div class="fixed bottom-4 right-4 z-50" x-data="{ open: false }">
  <button
    @click="open = !open"
    class="flex items-center gap-1.5 px-3 py-2 bg-base-900 hover:bg-base-800 text-white text-xs font-medium rounded-full shadow-lg transition-colors"
  >
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
    </svg>
    {languageNames[locale]}
  </button>

  <div
    x-show="open"
    @click.outside="open = false"
    x-transition:enter="transition ease-out duration-100"
    x-transition:enter-start="transform opacity-0 scale-95"
    x-transition:enter-end="transform opacity-100 scale-100"
    x-transition:leave="transition ease-in duration-75"
    x-transition:leave-start="transform opacity-100 scale-100"
    x-transition:leave-end="transform opacity-0 scale-95"
    class="absolute bottom-full right-0 mb-2 bg-white rounded-lg shadow-xl border border-base-200 overflow-hidden min-w-[140px]"
  >
    {locales.map((lang) => (
      <button
        data-lang={lang}
        class:list={[
          "language-btn w-full flex items-center gap-2 px-4 py-2.5 text-sm hover:bg-base-50 transition-colors text-left",
          locale === lang ? "bg-base-100 font-medium text-base-900" : "text-base-600"
        ]}
      >
        <span class="font-semibold">{languageNames[lang]}</span>
        <span class="text-base-500">{t.language[lang]}</span>
        {locale === lang && (
          <svg class="w-4 h-4 ml-auto text-rose-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        )}
      </button>
    ))}
  </div>
</div>

<script>
  function setupLanguageSwitcher() {
    const buttons = document.querySelectorAll('.language-btn');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        if (lang) {
          // Cookie-yə yaz (1 il müddətinə)
          document.cookie = `lang=${lang};path=/;max-age=31536000`;
          // Səhifəni yenilə
          window.location.reload();
        }
      });
    });
  }

  setupLanguageSwitcher();
  document.addEventListener('astro:after-swap', setupLanguageSwitcher);
</script>
